<!DOCTYPE html>
<html lang="de">
<head>
                <title>tech.x4343</title>
        <meta charset="utf-8" />
                                                                        
        <link rel="stylesheet" href="http://tech.x4343.org/theme/css/rdark.css" />
	<link rel="stylesheet" type="text/css" href="http://tech.x4343.org/theme/css/main.css" />
        <link href="http://tech.x4343.org/" type="application/atom+xml" rel="alternate" title="tech.x4343 ATOM Feed" /><!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
                	
<!-- Using MathJax, with the delimiters $ -->
<!-- Conflict with pygments for the .mo and .mi -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://tech.x4343.org">tech.x4343 <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
                                          </ul></nav><!-- /#menu -->
        <section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://tech.x4343.org/posts/2013/06/skript-zum-loggen-von-leistungsdaten/" rel="bookmark"
         title="Permalink to Skript zum Loggen von Leistungsdaten">Skript zum Loggen von Leistungsdaten</a></h2>
  
  </header>
  <footer class="post-info">
    <abbr class="published" title="2013-06-28T16:20:00">
      Fr 28 Juni 2013
    </abbr>
        <address class="vcard author">
      By <a class="url fn" href="http://tech.x4343.org/author/x4343.html">x4343</a>
    </address>
      </footer><!-- /.post-info -->
  <div class="entry-content">
    <html><body><h2>Idee</h2>
<p>Als ich meinen Raspberry bekommen habe kam schnell der Wunsch, alle interessanten Parameter zu loggen.
Eigentlich nur, weil ich einerseits ein bisschen Skripten lernen wollte und andererseits <em>irgendwann</em> ein paar Auswertungen über die gesammelten Daten machen kann.</p>
<p>Da das ganze <em>für den Anfang</em> möglichst einfach sein sollte, habe ich mich für bash entschieden. In Python wäre das ganze sicherlich mit noch mehr Funktionen und verschachtelter etc etc... möglich gewesen,
aber für meine einfachen Zwecke reicht bash vollkommen aus.</p>
<p>Folgende Parameter sollten ständig geloggt werden:</p>
<ul>
<li>CPU Auslastung (Load, wenn möglich auch prozentuale Auslastung)</li>
<li>RAM Auslastung</li>
<li>Benutzter Festplattenspeicher (SD Karte)</li>
<li>Spannung / Stromverbrauch, um einen langfristen Leistungsverbrauch berechnen zu können</li>
<li>Systemtemperatur</li>
<li><em>evtl. externe Sensoren für genauere Temperaturen etc.</em></li>
</ul>
<h2>Realisierung</h2>
<p>Das bash Skript soll minütlich alle gewünschten Werte in eine Datenbank schreiben.
Eine einfache .csv Datei kam nicht infrage, da anschließendes Suchen und Filtern zu kompliziert werden würde. Schon allein eine Größe von wenigen MB impliziert einige zehntausend Zeilen.
Diese zu durchsuchen...kein Bock drauf.
Zumal der Raspberry ja nicht nur mit sich selbst beschäftigt sein soll.</p>
<p>Also muss eine adäquate Datenbank her. </p>
<p>MySQL? Funktioniert sicher gut. Aber ist für meine Anwendung dann doch zuviel des Guten.
Besser SQLite. Selber Syntax (zumindest für die wichtigsten Befehle), leicht, schnell, handlich!</p>
<p>SQLite wird bspw. auch von Firefox, FileZilla etc. benutzt. Reicht also für meine Zwecke vollkommen aus.</p>
<p>Ein großer Vorteil von SQLite: Die gesamte DB befindet sich in einer Datei. Somit ist der Austausch zwischen einzelnen Rechnern schnell gemacht. Auch ein tägliches Backup ist kein Problem: </p>
<div class="highlight"><pre>cp datenbank.db datenbank.backup
</pre></div>
<p>Schnell ist eine entsprechende Datenbank mit einer Tabelle <code>tbl1</code> erstellt.
Anschließend die notwendigen Spalten mit Datentyp hinzufügen. Da bei mir nur Zahlen geloggt werden, reicht als Datentyp <em>Integer</em>.</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tbl1</span><span class="p">(</span><span class="n">time</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cpu_temp</span> <span class="nb">int</span><span class="p">,</span><span class="n">cpu_freq</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cpu_freq_min</span> <span class="nb">int</span><span class="p">,</span><span class="err">\</span>
<span class="n">cpu_freq_max</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cpu_load_1m</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cpu_load_5m</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cpu_load_15m</span> <span class="nb">int</span><span class="p">,</span><span class="err">\</span>
<span class="n">cpu_perc_user</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cpu_perc_total</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
<p>Diese können nun ganz einfach mit Werten gefüllt werden. Dazu werden die Werte via bash in Variablen geschrieben und diese per <code>INSERT</code> Befehl in eine neue Zeile der Datenbank geschrieben.</p>
<h2>Befehle</h2>
<p>Im Grunde lassen sich alle Parameter mehr oder weniger mit einem Einzeiler in <code>cat</code> auslesen.
Die entsprechenden Files befinden sich in <code>/sys</code> oder <code>/proc</code>.</p>
<p>Für den Arbeitsspeicher ist bspw. folgender Befehl notwendig:</p>
<div class="highlight"><pre>cat /proc/meminfo
</pre></div>
<p>Als Ergebnis bekommt man eine ganze Palette an Informationen zurückgeliefert.</p>
<div class="highlight"><pre>MemTotal:        7601364 kB
MemFree:          147184 kB
Buffers:          102844 kB
Cached:          5981016 kB
SwapCached:          140 kB
<span class="o">[</span>...<span class="o">]</span>
DirectMap4k:       64416 kB
DirectMap2M:     7874560 kB
</pre></div>
<p>Da längst nicht alle benötigt werden, muss noch ein bisschen gefiltert <code>grep</code> und gekürzt <code>cut</code> werden. Der benutzte Arbeitsspeicher lässt sich einfach mit <em>let</em> ausrechnen.</p>
<div class="highlight"><pre><span class="nv">MEM_TOTAL</span><span class="o">=</span><span class="k">$(</span>cat /proc/meminfo | grep <span class="s2">"MemTotal"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nv">MEM_FREE</span><span class="o">=</span><span class="k">$(</span>cat /proc/meminfo | grep <span class="s2">"MemFree"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nb">let</span> <span class="s2">"MEM_USED=($MEM_FREE*100) / $MEM_TOTAL"</span> 
</pre></div>
<p>So ähnlich funktioniert das auch für die entsprechenden Werte der CPU und SD Karte. Und ich bin mir sicher es gibt noch zig weitere interessante Werte die man mal eben so abfragen kann.
(Ich erinnere mich bei meinem N900 kann man auch so den Neigungssensor auslesen. Wäre auch ein interessanter Gnuplot wert. Warum? Weil man es kann!)</p>
<h2>Das Skript</h2>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">#   Funktion zur Umwandlung von Dateigroessen (e.g. 3.6G, 24.1M, 340K) in Kilobyte ohne Angabe der Einheit (-&gt; 3774873, 24678, 340)</span>
<span class="k">function </span>calc<span class="o">()</span>
<span class="o">{</span>
 <span class="c">#  Uebergabe des ersten Arguments [$1] an (lokale) Variable</span>
 <span class="nv">__resultvar</span><span class="o">=</span><span class="nv">$1</span>

 <span class="k">case</span> <span class="s2">"${__resultvar: -1}"</span> in    <span class="c">#  Switch-Case Auswertung des letzten Zeichens (e.g. 3.6G -&gt; G) (Groesseneinheit)</span>

  K<span class="o">)</span> <span class="c">#  Kilobyte</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | sed <span class="s1">'s/K//g'</span><span class="k">)</span>    <span class="c">#   Loesche Indikator (K)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | cut -d. -f1<span class="k">)</span> <span class="c">#   Abschneiden der Nachkommastellen</span>
     <span class="nb">echo</span> <span class="nv">$__resultvar</span>
     ;;                 <span class="c">#   Rueckgabewert</span>

  M<span class="o">)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | sed <span class="s1">'s/M//g'</span><span class="k">)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span>*1024 | bc -l<span class="k">)</span>  <span class="c">#   Umrechnung von Megabyte in Kilobyte</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | cut -d. -f1<span class="k">)</span>
     <span class="nb">echo</span> <span class="nv">$__resultvar</span>
     ;;

  G<span class="o">)</span> <span class="c">#  Gigabyte</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | sed <span class="s1">'s/G//g'</span><span class="k">)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span>*1024*1024 | bc -l<span class="k">)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | cut -d. -f1<span class="k">)</span>
     <span class="nb">echo</span> <span class="nv">$__resultvar</span>
     ;;

  T<span class="o">)</span> <span class="c">#  Terabyte</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | sed <span class="s1">'s/T//g'</span><span class="k">)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span>*1024*1024*1024 | bc -l<span class="k">)</span>
     <span class="nv">__resultvar</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$__resultvar</span> | cut -d. -f1<span class="k">)</span>
     <span class="nb">echo</span> <span class="nv">$__resultvar</span>
     ;;

 <span class="k">esac</span>
<span class="o">}</span>

<span class="c">#Initializing global variables</span>
<span class="nv">FILE</span><span class="o">=</span><span class="nv">$HOME</span>/skripte/log.txt

<span class="c">#Getting System Data</span>

<span class="c">#Time</span>
<span class="nv">TIME</span><span class="o">=</span><span class="k">$(</span>date +%s<span class="k">)</span>

<span class="c">#   CPU</span>
<span class="nv">CPU_TEMP</span><span class="o">=</span><span class="k">$(</span>cat /sys/class/thermal/thermal_zone0/temp<span class="k">)</span>
<span class="nv">CPU_FREQ</span><span class="o">=</span><span class="k">$(</span>cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq<span class="k">)</span>
<span class="nv">CPU_FREQ_MIN</span><span class="o">=</span><span class="k">$(</span>cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq<span class="k">)</span>
<span class="nv">CPU_FREQ_MAX</span><span class="o">=</span><span class="k">$(</span>cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq<span class="k">)</span>
<span class="nv">CPU_LOAD_1M</span><span class="o">=</span><span class="k">$(</span>cat /proc/loadavg | cut -d <span class="s1">' '</span> -f1<span class="k">)</span>
<span class="nv">CPU_LOAD_5M</span><span class="o">=</span><span class="k">$(</span>cat /proc/loadavg | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nv">CPU_LOAD_15M</span><span class="o">=</span><span class="k">$(</span>cat /proc/loadavg | cut -d <span class="s1">' '</span> -f3<span class="k">)</span>
<span class="nv">CPU_PERC_USER</span><span class="o">=</span><span class="k">$(</span>cat /proc/stat | grep cpu0 | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nv">CPU_PERC_NICE</span><span class="o">=</span><span class="k">$(</span>cat /proc/stat | grep cpu0 | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f3<span class="k">)</span>
<span class="nv">CPU_PERC_SYSTEM</span><span class="o">=</span><span class="k">$(</span>cat /proc/stat | grep cpu0 | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f4<span class="k">)</span>
<span class="nv">CPU_PERC_IDLE</span><span class="o">=</span><span class="k">$(</span>cat /proc/stat | grep u0 | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f5<span class="k">)</span>

<span class="c">#   RAM</span>
<span class="nv">MEM_TOTAL</span><span class="o">=</span><span class="k">$(</span>cat /proc/meminfo | grep <span class="s2">"MemTotal"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nv">MEM_FREE</span><span class="o">=</span><span class="k">$(</span>cat /proc/meminfo | grep <span class="s2">"MemFree"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nb">let</span> <span class="s2">"MEM_USED=($MEM_FREE*100) / $MEM_TOTAL"</span> 

<span class="c">#   SD Speicherkapazitaet</span>
<span class="nv">ROOTFS_TOTAL</span><span class="o">=</span><span class="k">$(</span>df -h | grep <span class="s2">"rootfs"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f2<span class="k">)</span>
<span class="nv">ROOTFS_TOTAL</span><span class="o">=</span><span class="k">$(</span>calc <span class="nv">$ROOTFS_TOTAL</span><span class="k">)</span>

<span class="nv">ROOTFS_USED</span><span class="o">=</span><span class="k">$(</span>df -h | grep <span class="s2">"rootfs"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f3<span class="k">)</span>
<span class="nv">ROOTFS_USED</span><span class="o">=</span><span class="k">$(</span>calc <span class="nv">$ROOTFS_USED</span><span class="k">)</span>

<span class="nv">ROOTFS_FREE</span><span class="o">=</span><span class="k">$(</span>df -h | grep <span class="s2">"rootfs"</span> | tr -s <span class="s1">' '</span> | cut -d <span class="s1">' '</span> -f4<span class="k">)</span>
<span class="nv">ROOTFS_FREE</span><span class="o">=</span><span class="k">$(</span>calc <span class="nv">$ROOTFS_FREE</span><span class="k">)</span>

<span class="c">#   Writing to SQLite</span>
sqlite3 <span class="nv">$HOME</span>/skripte/mon.db <span class="s2">"insert into tbl1 values ($TIME,$CPU_TEMP,$CPU_FREQ,$CPU_FREQ_MIN,$CPU_FREQ_MAX,\</span>
<span class="s2">$CPU_LOAD_1M,$CPU_LOAD_5M,$CPU_LOAD_15M,$CPU_PERC_USER,$CPU_PERC_NICE,$CPU_PERC_SYSTEM,$CPU_PERC_IDLE,$MEM_TOTAL,\</span>
<span class="s2">$MEM_FREE,$MEM_USED,$ROOTFS_TOTAL,$ROOTFS_USED,$ROOTFS_FREE);"</span>

<span class="c">#echo "Total: $ROOTFS_TOTAL\nUsed: $ROOTFS_USED\nFree: $ROOTFS_FREE"</span>
</pre></div></body></html>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>